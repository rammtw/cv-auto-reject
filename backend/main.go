package main

import (
	"encoding/json"
	"log"
	"math/rand"
	"net/http"
	"time"
)

type ErrorResponse struct {
	Error string `json:"error"`
}

type SuccessResponse struct {
	Message string `json:"message"`
}

var rejectionMessages = []string{
	"Ваше резюме похоже на тестовый файл, а мы ищем боевого кандидата.",
	"Мы решили, что вы слишком хороши для этой позиции и можете заскучать.",
	"В компании сейчас мороторий на найм людей умнее тимлида.",
	"Ваш опыт впечатляет, но стэк команды застрял в 2010 году.",
	"Нам нужен человек, который любит митинги, а вы, похоже, любите работать.",
	"Ваши скиллы слишком широкие, мы предпочитаем узкую специализацию по одному фреймворку.",
	"У нас уже есть один сильный разработчик, больше нам не одобрили.",
	"По ощущениям, вы будете задавать слишком много неудобных вопросов.",
	"Ваше резюме слишком структурировано, у нас хаос, вы не впишетесь.",
	"Мы боимся, что вы быстро заберёте место тимлида.",
	"HR сказал(а), что вы слишком честно пишете про технологии.",
	"У нас нет такого уровня задач, чтобы разгрузить ваш потенциал.",
	"Вы слишком инициативны, а у нас инициатива наказуема.",
	"Ваш GitHub нас напугал — там слишком много кода.",
	"Мы не поняли, как вам продавать корпоративные тимбилдинги.",
	"Ваша фотография в резюме слишком профессиональная, мы так не умеем.",
	"Мы не нашли у вас строчки «стрессоустойчивость», а нам это важно по бумажке.",
	"Ваш опыт автоматизации может случайно автоматизировать половину менеджмента.",
	"Ваша зарплатная вилка напомнила нам о реальности, а мы её избегаем.",
	"Вы пишете тесты, а у нас тесты — это пользователи в проде.",
	"Нам показалось, что вы будете рефакторить легаси, а оно дороже золота.",
	"У нас пока нет таски под такой уровень ответственности.",
	"Ваш профиль выглядит так, будто вы быстро найдёте работу лучше.",
	"Ваши pet-проекты сильнее наших боевых систем.",
	"Мы боимся, что вам станет скучно уже через две недели.",
	"По резюме видно, что вы любите понятные процессы, а у нас их нет.",
	"Вы слишком быстро отвечали на письма, это выбивает нас из графика.",
	"Ваш опыт в Go выше, чем у нашего главного гофера.",
	"Вы задавали слишком осмысленные вопросы на интервью.",
	"Нам нужен разработчик, который согласен на овертаймы без вопросов.",
	"У вас слишком чистый код, а у нас культ горячих фиксов.",
	"По резюме видно, что вы будете всё мониторить, а мы привыкли к сюрпризам.",
	"Ваши практики CI/CD могут случайно что-то улучшить, а это риск.",
	"Мы не нашли у вас любви к бесконечным созвонам.",
	"У нас строгая политика: сначала свой, потом сильный кандидат.",
	"Ваше резюме слишком краткое, нам привычнее на 10 страниц.",
	"По резюме видно, что вы умеете говорить «нет», а это конфликтно.",
	"Ваш подход к архитектуре может задеть чувства текущих решений.",
	"Вы слишком уверенно относитесь к типизации, а у нас всё на JSON.",
	"Кажется, вы будете спрашивать «зачем», а мы любим «надо».",
	"Вы явно умеете выбирать инструменты, а у нас всё уже выбрали до вас.",
	"Мы боимся, что вы оптимизируете процессы быстрее, чем мы к этому готовы.",
	"Ваше резюме похоже на roadmap для команды, а мы пока не доросли.",
	"Нам нужен человек, который согласен «и фронт, и бэк, и DevOps, и аналитику».",
	"Вы слишком хорошо понимаете нагрузочное тестирование, а мы — нет.",
	"Слишком много реальных достижений, а у нас KPI по слайдам.",
	"Мы не нашли у вас опыта работы с нашим главным легаси-фреймворком.",
	"Ваши ценности про баланс работы и жизни не совпали с нашими спринтами.",
	"Ваш опыт подсказал нам, что вам стоит целиться в более сильные команды.",
	"Мы решили, что сейчас не потянем такого уровня экспертизу.",
	"Ваше резюме вдохновляет, а у нас пока нет вдохновляющих задач.",
}

func main() {
	rand.Seed(time.Now().UnixNano())

	http.HandleFunc("/api/upload", uploadHandler)

	handler := corsMiddleware(http.DefaultServeMux)

	log.Println("Server listening on :8080")
	if err := http.ListenAndServe(":8080", handler); err != nil {
		log.Fatal(err)
	}
}

func uploadHandler(w http.ResponseWriter, r *http.Request) {
	if r.Method != http.MethodPost {
		http.Error(w, "method not allowed", http.StatusMethodNotAllowed)
		return
	}

	r.Body = http.MaxBytesReader(w, r.Body, 5*1024*1024+1024)

	if err := r.ParseMultipartForm(5 * 1024 * 1024); err != nil {
		writeError(w, http.StatusBadRequest, "Размер файла не должен превышать 5 МБ.")
		return
	}

	file, header, err := r.FormFile("file")
	if err != nil {
		writeError(w, http.StatusBadRequest, "Файл не найден в запросе.")
		return
	}
	defer file.Close()

	if header.Filename != "cv.pdf" {
		writeError(w, http.StatusBadRequest, "Имя файла должно быть строго 'cv.pdf'.")
		return
	}

	if header.Size > 5*1024*1024 {
		writeError(w, http.StatusBadRequest, "Размер файла не должен превышать 5 МБ.")
		return
	}

	delay := 3 + rand.Intn(3) // 3,4,5
	time.Sleep(time.Duration(delay) * time.Second)

	msg := rejectionMessages[rand.Intn(len(rejectionMessages))]

	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(SuccessResponse{Message: msg})
}

func writeError(w http.ResponseWriter, status int, msg string) {
	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(status)
	_ = json.NewEncoder(w).Encode(ErrorResponse{Error: msg})
}

func corsMiddleware(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		w.Header().Set("Access-Control-Allow-Origin", "http://localhost:3002")
		w.Header().Set("Access-Control-Allow-Methods", "POST, OPTIONS")
		w.Header().Set("Access-Control-Allow-Headers", "Content-Type")
		if r.Method == http.MethodOptions {
			return
		}
		next.ServeHTTP(w, r)
	})
}
